<template>
    <style>

        .show-map{
            padding: 15px;
        }

        #map { 
            height: 300px;
/*            max-width: 75vw; */
        }

        #layer{
            cursor: pointer;
            text-align: end;
        }

         #layer:hover{
            color: blue;
         }

         .track-atleta{
            display: flex;
            flex-direction: row;
         }

        /* SLIDERS */

        #seg-map { 
            height: 300px;
/*            max-width: 75vw; */
        }



        .sliders_control {
        position: relative;
        min-height: 50px;
        max-width: 95%;
        }

        input[type=range]::-moz-range-thumb {
/*        -webkit-appearance: none;*/
        pointer-events: all;
        width: 24px;
        height: 24px;
        background-color: #c03b3b;
        border-radius: 50%;
        box-shadow: 0 0 0 1px #C6C6C6;
        cursor: pointer;  
        z-index: 10;
        }

        input[type="range"] {
/*            -webkit-appearance: none; */
            appearance: none;
            height: 2px;
            width: 100%;
            position: absolute;
            background-color: #C6C6C6;
            pointer-events: none;
        }

        #iniSlider {
            height: 0;
            z-index: 1;
        }


    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <div class="show-map">
        <div class="head">
            <div class="track-atleta">
                <img class="post-head-img" id="track-user" src="">
                <p id="track-nome-atleta"></p>
            </div>
            <div class="track-data">
                <div>
                    <p>Distância</p>
                    <p id="track-dist"></p>
                    <p class="track-und">Km</p>
                </div>
                <div>
                    <p>Elevação</p>
                    <p id="track-elev"></p>
                    <p class="track-und">m</p>
                </div>
                <div>
                    <p>Tempo Mov.</p>
                    <p id="track-mov"></p>
                    <p class="track-und">h</p>
                </div>
                <div>
                    <p>Tempo Tot.</p>
                    <p id="track-time"></p>
                    <p class="track-und">h</p>
                </div>
            </div>
        </div>
        <div id="layer">View Sat</div>
        <div id="map"></div>
        <div class="sliders_control">
            <input id="iniSlider" type="range" value="10" min="0"/>
            <input id="finSlider" type="range" value="20" min="0"/>
        </div>
        <div id="chart_div" style="width: 100%;"></div>
        <div class="track-seg">
            <p>Seguimentos</p>
            <p id="seg">Novo Seguimento</p>
        </div>
    </div>

</template>
<script>

    const pageData = main_data.post_track.data
    const pageFunc = main_data.post_track.func
    const pageScreen = document.querySelector('#card-post_track')
    const ini = pageScreen.querySelector('#iniSlider')
    const fin = pageScreen.querySelector('#finSlider')

    function pageStart(){
        
        pageScreen.querySelector('#track-user').src = pageData.img
        pageScreen.querySelector('#track-nome-atleta').innerHTML = pageData.nome_usuario
        pageScreen.querySelector('#track-dist').innerHTML = pageData.dist
        pageScreen.querySelector('#track-elev').innerHTML = pageData.elev
        const mov_h = Math.floor(pageData.mov_time/3600).toString().padStart(2,0)
        const mov_m = Math.round(((pageData.mov_time/3600)%1) * 60).toString().padStart(2,0)
        pageScreen.querySelector('#track-mov').innerHTML = mov_h+':'+mov_m
        const tot_h = Math.floor(pageData.time/3600).toString().padStart(2,0)
        const tot_m = Math.round(((pageData.time/3600)%1) * 60).toString().padStart(2,0)        
        pageScreen.querySelector('#track-time').innerHTML = tot_h+':'+tot_m
        getFile(pageData.file).then((resp)=>{
            pageData.gps = JSON.parse(resp)

            pageData.map = newMap([pageData.gps.points[0].lat,pageData.gps.points[0].lon],'map')
            pageData.alt =  drawTrack(pageData.gps.points,pageData.map)
            drawAlt(pageData)

            ini.max = pageData.gps.points.length-1
            fin.max = pageData.gps.points.length-1
            ini.value = Math.floor(pageData.gps.points.length / 3)
            fin.value = Math.floor(pageData.gps.points.length / 3) * 2

            drawSeg()

        })

        if(pageData.owner != '1'){
            pageScreen.querySelector('#seg').style.display = 'none'
        }

    }

    function drawSeg(){
        pageData.seg = pageData.gps.points.filter((el,i)=>(i>=ini.value && i<= fin.value))
//        pageData.alt.fill(0,0,ini.value)
//        pageData.alt.fill(0,fin.value,pageData.alt.length)

        console.log(pageData.alt.filter((el,i)=>(i>=ini.value && i<= fin.value)) )
        drawTrack(pageData.seg, pageData.map,'seg','red',0)
    }

    pageScreen.querySelector('#layer').addEventListener('click',()=>{
        if(pageData.map.layer.name == 'sat'){
            pageScreen.querySelector('#layer').innerHTML = 'View Sat'
        }else{
            pageScreen.querySelector('#layer').innerHTML = 'View Map'
        }
        setLayer(pageData.map.layer.name == 'map' ? 'sat' : 'map')
    })

    pageScreen.querySelector('#seg').addEventListener('click',()=>{
        if(pageData.owner == '1'){
            openHTML('post_seg.html','pop-up','Novo Seguimento',pageData,600)
        }
    })

    ini.addEventListener('input',()=>{
        ini.value = Number(ini.value) > Number(fin.value) ? fin.value : ini.value
        try{
            pageData.map.removeLayer(pageData.map.mark_ini);
        }catch{null}
        pageData.map.mark_ini = L.marker([pageData.gps.points[ini.value].lat,pageData.gps.points[ini.value].lon]).addTo(pageData.map)

        drawSeg()
    })

    fin.addEventListener('input',()=>{
        fin.value = Number(ini.value) > Number(fin.value) ? ini.value : fin.value
        try{
            pageData.map.removeLayer(pageData.map.mark_fin);
        }catch{null}
        pageData.map.mark_fin = L.marker([pageData.gps.points[fin.value].lat,pageData.gps.points[fin.value].lon]).addTo(pageData.map)
        drawSeg()
    })

    pageStart()

</script>